<!DOCTYPE html>
<html lang="fr"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Porte-Clé • Exercices</title>
<link rel="icon" href="assets/icon.png"><link rel="stylesheet" href="assets/css/styles.css">
<script type="module">
import { $, loadDatasets, markActive, recordRule, shuffle, pick } from './assets/js/app.js';
window.addEventListener('DOMContentLoaded', async ()=>{
  markActive();
  const data = await loadDatasets();
  const domaines = [...new Set(data.map(d=>d.domaine))].sort();
  const selDom = document.querySelector('#domainSelect');
  const selRule = document.querySelector('#ruleSelect');

  domaines.forEach(dom=>{ const o=document.createElement('option'); o.value=dom; o.textContent=dom; selDom.appendChild(o); });

  const params = new URLSearchParams(location.search);
  const paramD = params.get('d'); const paramR = params.get('r');
  if (paramD && domaines.includes(paramD)) selDom.value = paramD;

  function populateRules(){
    selRule.innerHTML='';
    const rules = data.filter(x=>x.domaine===selDom.value);
    rules.forEach(r=>{ const o=document.createElement('option'); o.value=r.id; o.textContent=r.titre; selRule.appendChild(o); });
    if (paramR) selRule.value = paramR;
  }

  selDom.addEventListener('change', ()=>{ populateRules(); run(); });
  selRule.addEventListener('change', run);
  populateRules(); run();

  function run(){
    const chosenId = selRule.value;
    const rule = data.find(d=>d.id===chosenId);
    const area = document.querySelector('#content'); area.innerHTML='';
    if(!rule){ area.innerHTML = '<div class="card empty"><p>Choisis une fiche.</p></div>'; return; }

    const items = (rule.items && rule.items.length) ? rule.items : [
      { q:'Complète : Le chat ___ sur le mur.', a:'saute' },
      { q:'Choisis : Leur / Leurs — ___ cartable est rouge.', a:'Leur' },
      { q:'Transforme au présent : (nous) chanter', a:'nous chantons' }
    ];
    const picked = pick(shuffle(items.slice()), 8);

    picked.forEach((it,idx)=>{
      const row=document.createElement('div'); row.className='card';
      row.innerHTML = `<div class="badge">Ex ${idx+1}</div><p>${it.q||it.question||it.texte}</p>
        <input data-a="${(it.a||it.reponse||'').toString().trim().toLowerCase()}" placeholder="Ta réponse…">`;
      area.appendChild(row);
    });
    document.querySelector('#validate').onclick = ()=>{
      let ok=0, tot=0;
      document.querySelectorAll('#content input').forEach(inp=>{
        tot++; const user=(inp.value||'').trim().toLowerCase().replace(/[.!?]$/,'');
        const ans=inp.dataset.a;
        if(ans){ if(user===ans){ ok++; inp.style.borderColor='var(--ok)'; } else { inp.style.borderColor='var(--bad)'; } }
      });
      document.querySelector('#score').textContent = ok + ' / ' + tot;
      recordRule(rule.id, ok===tot ? 'success' : 'attempt');
    };
  }
});
</script>
</head>
<body>
<nav class="top"><div class="inner">
<img class="logo" src="assets/icon.png" alt=""><span class="brand">Porte-Clé</span><div style="flex:1"></div>
<a href="index.html">Accueil</a><a href="theorie.html">Théorie</a><a class="active" href="exercices.html">Exercices</a><a href="compte.html">Compte</a>
</div></nav>
<main class="app">
  <h1>Exercices</h1>
  <div class="controls"><label for="domainSelect">Domaine</label><select id="domainSelect"></select><label for="ruleSelect">Fiche</label><select id="ruleSelect"></select></div>
  <section id="content" class="grid" style="margin-top:14px"></section>
  <div class="kpis"><div class="kpi"><div>Score</div><strong id="score">—</strong></div><button id="validate">Valider</button></div>
</main>
</body></html>